#!/usr/bin/env python

__author__="Sergio Maffioletti (sergio.maffioletti@gc3.uzh.ch)"
__date__="01 January 2009"
__copyright__="Copyright 2009 2011 Grid Computing Competence Center - UZH/GC3"
__version__="0.1a"

import logging
import os
import sys
from optparse import OptionParser

from gc3utils.campusgrid import *
from gc3utils import campusgrid

default_config_file_location="$HOME/.gc3/config"
default_joblist_location = "$HOME/.gc3/.joblist"
default_joblist_lock= "$HOME/.gc3/.joblist_lock"
resource_list = {}
defaults = {}

LRMSLOG_PREFIX='=== gget ===\n'

def main():

  global default_joblist_location
  global default_joblist_lock

  try:
    # Parse command line arguments
    
    _usage = "Usage: %prog [options] jobid"
    parser = OptionParser(usage=_usage)
    parser.add_option("-v", action="count", dest="verbosity", default=0, help="Set verbosity level")
    (options, args) = parser.parse_args()

    # Configure logging service
    configure_logging(options.verbosity)

    if len(args) != 1:
      logging.critical('Command line argument parsing\t\t\t[ failed ]\n\tIncorrect number of arguments; expected 1 got %d ',len(args))
      parser.print_help()
      raise Exception('wrong number on arguments')


    logging.info('Parsing command line arguments\t\t[ ok ]')
    
    # todo : change this variable name.  It should be unique_token or jobid.  
    lrms_jobid = args[0]

    # read configuration file
    (defaults,resource_list) = readConfig(default_config_file_location)

    logging.info('Loading configuration file\t\t\t[ ok ]')

    if ( (os.path.exists(lrms_jobid) == False ) | (os.path.isdir(lrms_jobid) == False) | ( not check_inputfile(lrms_jobid+'/'+defaults['lrms_jobid']) ) ):
      logging.critical('Jobid Not valid')
      raise Exception('invalid jobid')

    logging.info('lrms_jobid file check\t\t\t[ ok ]')

    # check .finished file
    if ( not check_inputfile(lrms_jobid+'/'+defaults['lrms_finished']) ):
      _fileHandle = open(lrms_jobid+'/'+defaults['lrms_jobid'],'r')
      _raw_resource_info = _fileHandle.read()
      _fileHandle.close()

      _list_resource_info = re.split('\t',_raw_resource_info)

      logging.debug('lrms_jobid file returned %s elements',len(_list_resource_info))

      if ( len(_list_resource_info) != 2 ):
        raise Exception('failed retieving jobid')

      logging.debug('frontend: [ %s ] jobid: [ %s ]',_list_resource_info[0],_list_resource_info[1])
      logging.info('reading lrms_jobid info\t\t\t[ ok ]')

      if ( _list_resource_info[0] in resource_list ):
        logging.debug('Found match for resource [ %s ]',_list_resource_info[0])
        logging.debug('Creating lrms instance')
        resource = resource_list[_list_resource_info[0]]
        if ( resource['type'] == "arc" ):
          lrms = ArcLrms(resource)
        elif ( resource['type'] == "ssh"):
          lrms = SshLrms(resource)
        else:
          logging.error('Unknown resource type %s',resource['type'])
          raise  Exception('unknown resource type')

        if ( (lrms.isValid != 1) | (lrms.check_authentication() == False) ):
          logging.error('Failed validating lrms instance for resource %s',resource['resource_name'])
          raise Exception('failed authenticating to LRMS')

        logging.info('Init LRMS\t\t\t[ ok ]')
        _lrms_jobid = _list_resource_info[1]
        #_lrms_dirfolder = dirname(lrms_jobid)
        (retval,lrms_log) = lrms.get_results(_lrms_jobid,lrms_jobid)

        # dump lrms_log
        try:
          logging.debug('Dumping lrms_log')
          _fileHandle = open(lrms_jobid+'/'+defaults['lrms_log'],'a')
          _fileHandle.write(LRMSLOG_PREFIX)
          _fileHandle.write(lrms_log+'\n')
          _fileHandle.close()
        except:
          logging.error('Failed dumping lrms_log [ %s ]',sys.exc_info()[1])

        if ( retval == False ):
          logging.error('Failed getting results')
          raise Exception('failed getting results from LRMS')

        logging.debug('check_status\t\t\t[ ok ]')

        # Job finished; results retrieved; writing .finished file
        try:
          logging.debug('Creating finished file')
          open(lrms_jobid+"/"+defaults['lrms_finished'],'w').close()      
        except:
          logging.error('Failed creating finished file [ %s ]',sys.exc_info()[1])
          # Should handle the exception differently ?

        logging.debug('Removing jobid from joblist file')
        # Removing jobid from joblist file
        try:          
          default_joblist_location = os.path.expandvars(default_joblist_location)
          default_joblist_lock = os.path.expandvars(default_joblist_lock)

          if ( obtain_file_lock(default_joblist_location,default_joblist_lock) ):
            _newFileHandle = tempfile.NamedTemporaryFile(suffix=".xrsl",prefix="gridgames_arc_")

            _oldFileHandle  = open(default_joblist_location)
            _oldFileHandle.seek(0)
            for line in _oldFileHandle:
              logging.debug('checking %s with %s',line,lrms_jobid)
              if ( not lrms_jobid in line ):
                logging.debug('writing line')
                _newFileHandle.write(line)

            _oldFileHandle.close()

            os.remove(default_joblist_location)

            _newFileHandle.seek(0)

            logging.debug('replacing joblist file with %s',_newFileHandle.name)
            os.system("cp "+_newFileHandle.name+" "+default_joblist_location)

            _newFileHandle.close()

          else:
            raise Exception('Failed obtain lock')
        except:
          logging.error('Failed updating joblist file in %s',default_joblist_location)
          logging.debug('Exception %s',sys.exc_info()[1])

        # release lock
        if ( (not release_file_lock(default_joblist_lock)) & (os.path.isfile(default_joblist_lock)) ):
          logging.error('Failed removing lock file')

      else:
        logging.critical('Failed finding matching resource name [ %s ]',_list_resource_info[0])
        raise

    sys.stdout.write('Job results successfully retrieved in [ '+lrms_jobid+' ]\n')
    sys.stdout.flush

    return 0

  except:
    logging.info('%s',sys.exc_info()[1])
    print "gget failed: "+str(sys.exc_info()[1])
    return 1

if __name__ == "__main__":
  sys.exit(main())
